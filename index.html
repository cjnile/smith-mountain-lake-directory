<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Smith Mountain Lake Directory</title>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
		}
		.header {
			background: white;
			padding: 20px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.1);
		}
		.header h1 {
			color: #333;
			margin-bottom: 5px;
		}
		.header p {
			color: #666;
		}
		.container {
			max-width: 1400px;
			margin: 20px auto;
			padding: 0 20px;
		}
		.controls {
			background: white;
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.1);
			margin-bottom: 20px;
		}
		.control-row {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			margin-bottom: 10px;
		}
		.search-box {
			flex: 1;
			min-width: 250px;
			padding: 12px;
			border: 2px solid #ddd;
			border-radius: 8px;
			font-size: 16px;
		}
		select {
			padding: 12px;
			border: 2px solid #ddd;
			border-radius: 8px;
			font-size: 16px;
			background: white;
		}
		button {
			padding: 12px 24px;
			border: none;
			border-radius: 8px;
			font-size: 16px;
			cursor: pointer;
			font-weight: 600;
			transition: all 0.3s;
		}
		.btn-primary {
			background: #667eea;
			color: white;
		}
		.btn-primary:hover {
			background: #5568d3;
		}
		.btn-secondary {
			background: #48bb78;
			color: white;
		}
		.btn-secondary:hover {
			background: #38a169;
		}
		.btn-danger {
			background: #f56565;
			color: white;
		}
		.btn-danger:hover {
			background: #e53e3e;
		}
		.btn-secondary:disabled, .btn-primary:disabled, .btn-danger:disabled {
			background: #9ca3af;
			cursor: not-allowed;
		}
		.view-toggle {
			display: flex;
			background: #f0f0f0;
			border-radius: 8px;
			padding: 4px;
		}
		.view-toggle button {
			background: transparent;
			color: #666;
		}
		.view-toggle button.active {
			background: white;
			color: #333;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
		.content {
			background: white;
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.1);
		}
		#map {
			width: 100%;
			height: 600px;
			border-radius: 8px;
		}
		.business-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
			gap: 20px;
		}
		.business-card {
			border: 2px solid #e0e0e0;
			border-radius: 10px;
			padding: 20px;
			transition: all 0.3s;
		}
		.business-card:hover {
			box-shadow: 0 5px 15px rgba(0,0,0,0.1);
			transform: translateY(-2px);
		}
		.business-name {
			font-size: 20px;
			font-weight: 700;
			color: #333;
			margin-bottom: 8px;
		}
		.business-category {
			display: inline-block;
			padding: 4px 12px;
			background: #667eea;
			color: white;
			border-radius: 20px;
			font-size: 12px;
			margin-bottom: 12px;
		}
		.business-detail {
			margin: 8px 0;
			color: #666;
			font-size: 14px;
		}
		.business-detail strong {
			color: #333;
		}
		.status-message {
			padding: 15px;
			border-radius: 8px;
			margin-top: 10px;
			text-align: center;
		}
		.status-success {
			background: #c6f6d5;
			color: #22543d;
		}
		.status-info {
			background: #bee3f8;
			color: #2c5282;
		}
		.status-error {
			background: #fed7d7;
			color: #742a2a;
		}
		.hidden { display: none; }
	</style>
</head>
<body>
	<div class="header">
		<h1>Smith Mountain Lake Directory</h1>
		<p>Your complete guide to businesses around the lake</p>
	</div>

	<div class="container">
		<div class="controls">
			<div class="control-row">
				<input type="text" id="searchBox" class="search-box" placeholder="Search businesses...">
				<select id="categoryFilter">
					<option value="all">All Categories</option>
				</select>
				<button class="btn-secondary" id="importBtn" onclick="importFromGoogle()">Import from Google Places</button>
				<button class="btn-danger" onclick="clearData()">Clear All Data</button>
				<div class="view-toggle">
					<button id="listViewBtn" class="active" onclick="switchView('list')">List</button>
					<button id="mapViewBtn" onclick="switchView('map')">Map</button>
				</div>
			</div>
			<div id="statusMessage"></div>
		</div>

		<div class="content">
			<div id="listView" class="business-grid"></div>
			<div id="mapView" class="hidden">
				<div id="map"></div>
			</div>
		</div>
		
		<div style="text-align:center; padding:20px; color:white; font-size:12px;">
			Version 4.1 - Supabase Database (Fixed)
		</div>
	</div>

	<script>
		// Initialize Supabase
		const SUPABASE_URL = 'https://oykvpzpdilajdonbvyop.supabase.co';
		const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95a3ZwenBkaWxhamRvbmJ2eW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMjA5NTMsImV4cCI6MjA4MTc5Njk1M30.Evz4X768qqCk9T73BBw5Y77KxbhlZx-UAd5F4gEm3nY';
		const sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

		// Google Maps loader
		(g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.googleapis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
			key: "AIzaSyCrj5ydDKjMGJN75Pe6sIdUyfh0dUCOMes",
			v: "weekly",
		});

		var businesses = [];
		var map;
		var markers = [];
		var currentView = 'list';
		var categoriesSet = new Set();
		
		// Load businesses from Supabase
		async function loadBusinessesFromDB() {
			try {
				showStatus('Loading businesses from database...', 'info');
				
				const { data, error } = await sbClient
					.from('businesses')
					.select('*')
					.order('name');
				
				if (error) throw error;
				
				if (data && data.length > 0) {
					businesses = data;
					updateCategories();
					renderBusinesses();
					showStatus('Loaded ' + businesses.length + ' businesses from database', 'success');
				} else {
					showStatus('No businesses found. Click "Import from Google Places" to populate the directory.', 'info');
					renderBusinesses();
				}
			} catch (error) {
				console.error('Error loading businesses:', error);
				showStatus('Error loading businesses: ' + error.message, 'error');
			}
		}
		
		// Save businesses to Supabase
		async function saveBusinessesToDB(newBusinesses) {
			try {
				const { data, error } = await sbClient
					.from('businesses')
					.insert(newBusinesses);
				
				if (error) throw error;
				
				console.log('Saved', newBusinesses.length, 'businesses to database');
				return true;
			} catch (error) {
				console.error('Error saving businesses:', error);
				showStatus('Error saving businesses: ' + error.message, 'error');
				return false;
			}
		}

		function showStatus(message, type) {
			var statusEl = document.getElementById('statusMessage');
			statusEl.className = 'status-message status-' + type;
			statusEl.innerHTML = message;
			statusEl.style.display = 'block';
		}

		async function importFromGoogle() {
			console.log('Import started');
			var btn = document.getElementById('importBtn');
			btn.disabled = true;
			btn.textContent = 'Importing...';
			
			showStatus('Loading Google Places API...', 'info');
			
			try {
				const { Place } = await google.maps.importLibrary("places");
				const { Map } = await google.maps.importLibrary("maps");
				
				showStatus('Searching for businesses...', 'info');
				
				var searchTerms = [
					'restaurants near Smith Mountain Lake Virginia',
					'hotels near Smith Mountain Lake Virginia',
					'cafes near Smith Mountain Lake Virginia',
					'shops near Smith Mountain Lake Virginia',
					'marinas near Smith Mountain Lake Virginia'
				];
				
				var allPlaces = [];
				
				for (var i = 0; i < searchTerms.length; i++) {
					var term = searchTerms[i];
					console.log('Searching:', term);
					
					var request = {
						textQuery: term,
						fields: ['displayName', 'formattedAddress', 'location', 'rating', 'types'],
						maxResultCount: 20
					};
					
					var result = await Place.searchByText(request);
					
					if (result.places && result.places.length > 0) {
						console.log('Found', result.places.length, 'places for', term);
						
						result.places.forEach(function(place) {
							var category = 'Other';
							if (term.includes('restaurant')) category = 'Restaurant';
							else if (term.includes('hotel')) category = 'Lodging';
							else if (term.includes('cafe')) category = 'Cafe';
							else if (term.includes('shop')) category = 'Store';
							else if (term.includes('marina')) category = 'Marina';
							
							allPlaces.push({
								name: place.displayName,
								category: category,
								address: place.formattedAddress || 'Address not available',
								lat: place.location.lat(),
								lng: place.location.lng(),
								rating: place.rating ? place.rating.toString() : 'N/A'
							});
						});
					}
					
					await new Promise(resolve => setTimeout(resolve, 300));
				}
				
				showStatus('Saving ' + allPlaces.length + ' businesses to database...', 'info');
				
				var saved = await saveBusinessesToDB(allPlaces);
				
				if (saved) {
					await loadBusinessesFromDB();
					showStatus('Successfully imported and saved ' + allPlaces.length + ' businesses!', 'success');
				}
				
				btn.disabled = false;
				btn.textContent = 'Import from Google Places';
				
			} catch (error) {
				console.error('Import error:', error);
				showStatus('Error: ' + error.message, 'error');
				btn.disabled = false;
				btn.textContent = 'Import from Google Places';
			}
		}

		function updateCategories() {
			categoriesSet.clear();
			businesses.forEach(function(b) {
				categoriesSet.add(b.category);
			});
			
			var select = document.getElementById('categoryFilter');
			select.innerHTML = '<option value="all">All Categories</option>';
			Array.from(categoriesSet).sort().forEach(function(cat) {
				var option = document.createElement('option');
				option.value = cat;
				option.textContent = cat;
				select.appendChild(option);
			});
		}

		function renderBusinesses() {
			var searchTerm = document.getElementById('searchBox').value.toLowerCase();
			var category = document.getElementById('categoryFilter').value;
			
			var filtered = businesses.filter(function(b) {
				var matchesSearch = b.name.toLowerCase().includes(searchTerm) || 
								   b.address.toLowerCase().includes(searchTerm);
				var matchesCategory = category === 'all' || b.category === category;
				return matchesSearch && matchesCategory;
			});
			
			var listView = document.getElementById('listView');
			listView.innerHTML = '';
			
			if (filtered.length === 0) {
				listView.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">No businesses found. Click "Import from Google Places" to load data.</p>';
				return;
			}
			
			filtered.forEach(function(business) {
				var card = document.createElement('div');
				card.className = 'business-card';
				card.innerHTML = 
					'<div class="business-name">' + business.name + '</div>' +
					'<span class="business-category">' + business.category + '</span>' +
					'<div class="business-detail"><strong>Address:</strong> ' + business.address + '</div>' +
					'<div class="business-detail"><strong>Rating:</strong> ' + business.rating + '</div>';
				listView.appendChild(card);
			});
		}

		function switchView(view) {
			currentView = view;
			
			document.getElementById('listViewBtn').classList.remove('active');
			document.getElementById('mapViewBtn').classList.remove('active');
			
			if (view === 'list') {
				document.getElementById('listViewBtn').classList.add('active');
				document.getElementById('listView').classList.remove('hidden');
				document.getElementById('mapView').classList.add('hidden');
			} else {
				document.getElementById('mapViewBtn').classList.add('active');
				document.getElementById('listView').classList.add('hidden');
				document.getElementById('mapView').classList.remove('hidden');
				initMap();
			}
		}

		async function initMap() {
			try {
				const { Map } = await google.maps.importLibrary("maps");
				
				if (!map) {
					map = new Map(document.getElementById('map'), {
						center: {lat: 37.0389, lng: -79.5847},
						zoom: 12,
						mapId: 'DEMO_MAP_ID'
					});
				}
				
				markers.forEach(function(marker) {
					marker.map = null;
				});
				markers = [];
				
				var searchTerm = document.getElementById('searchBox').value.toLowerCase();
				var category = document.getElementById('categoryFilter').value;
				
				var filtered = businesses.filter(function(b) {
					var matchesSearch = b.name.toLowerCase().includes(searchTerm) || 
									   b.address.toLowerCase().includes(searchTerm);
					var matchesCategory = category === 'all' || b.category === category;
					return matchesSearch && matchesCategory;
				});
				
				filtered.forEach(function(business) {
					var marker = new google.maps.Marker({
						position: {lat: business.lat, lng: business.lng},
						map: map,
						title: business.name
					});
					
					var infoWindow = new google.maps.InfoWindow({
						content: '<div style="padding:10px;"><strong>' + business.name + '</strong><br>' +
								 business.category + '<br>' + business.address + '<br>Rating: ' + business.rating + '</div>'
					});
					
					marker.addListener('click', function() {
						infoWindow.open(map, marker);
					});
					
					markers.push(marker);
				});
			} catch (error) {
				console.error('Map error:', error);
			}
		}

		async function clearData() {
			if (confirm('Are you sure you want to delete all ' + businesses.length + ' businesses from the database? This cannot be undone.')) {
				try {
					showStatus('Deleting all businesses...', 'info');
					
					const { error } = await sbClient
						.from('businesses')
						.delete()
						.neq('id', 0);
					
					if (error) throw error;
					
					businesses = [];
					updateCategories();
					renderBusinesses();
					showStatus('All data cleared from database', 'success');
				} catch (error) {
					console.error('Error clearing data:', error);
					showStatus('Error clearing data: ' + error.message, 'error');
				}
			}
		}

		document.getElementById('searchBox').addEventListener('input', function() {
			if (currentView === 'list') {
				renderBusinesses();
			} else {
				initMap();
			}
		});

		document.getElementById('categoryFilter').addEventListener('change', function() {
			if (currentView === 'list') {
				renderBusinesses();
			} else {
				initMap();
			}
		});

		// Load businesses on page load
		loadBusinessesFromDB();
	</script>
</body>
</html>